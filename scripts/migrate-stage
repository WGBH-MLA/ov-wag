# Commands for migrating AAPB in stage

# drop old db
k -n ov exec -it ov-db-cluster-1 -- psql -c 'drop database "ov-wag-pr-258";'
k -n ov delete database ov-wag-pr-258-database
k -n ov create database ov-wag-pr-258-database

POD=ov-wag-pr-258-backend-76d568d9f6-s6vbz

k -n ov cp ~/gbh/aapb/AAPB2/collections.json $POD:collections.json
k -n ov cp docs/dev/migrate-collections.py $POD:migrate-collections.py

k -n ov cp docs/dev/migrate-exhibits.py $POD:migrate-exhibits.py
k -n ov cp ~/gbh/aapb/AAPB2/exhibits.json $POD:exhibits.json


# in pod
pip install markdown
apt update
apt install -y git
pip install git+https://github.com/WGBH-MLA/AAPB2@cmless

python manage.py migrate

# Create AAPB home page in Wagtail
python manage.py shell -c '
from wagtail.models import Page, Site
from home.models import AAPBHomePage

root = Page.objects.get(id=1)

ov = Page.objects.get(id=3)
ov.title = "Open Vault"
ov.specific.save_revision().publish()

aapb = AAPBHomePage(title="AAPB", slug="aapb")
root.add_child(instance=aapb)
aapb.save_revision().publish()

aapb_site = Site(hostname="aapb", site_name="American Archive", root_page=aapb)
aapb_site.save()
'

# Collections
python migrate-collections.py
python manage.py shell -c '
def rename_slug(old_slug, new_slug):
    try:
        p = Page.objects.get(slug=old_slug)
        p.slug = new_slug
        p.save()
    except Page.DoesNotExist:
        print(f"Page with slug {old_slug} does not exist")

rename_slug("zoom", "zoom-collection")
rename_slug("le-show", "le-show-collection")
'

# Exhibits

python migrate-exhibits.py